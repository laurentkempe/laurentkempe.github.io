
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Laurent Kempé">
    <title>gRPC and C# 8 Async stream - Laurent Kempé</title>
    <meta name="author" content="Laurent Kempé">
    
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Laurent Kempé","sameAs":["https://github.com/laurentkempe","https://twitter.com/laurentkempe","https://www.linkedin.com/in/laurentkempe","https://flickr.com/photos/laurentkempe/"],"image":"https://farm2.staticflickr.com/1971/31306281378_02b055ccfe_q.jpg"},"articleBody":"gRPC and its idea to describe an API in a standardized file, which can generate both client and server code to interact in different languages is a compelling idea.In this post, I would like to have a quick look at the experience you would have with gRPC streaming capability and the new C# 8 async streams, which sounds like a perfect match.\n\nI am using the .NET Core CLI to create the solution with two projects, one for the server called grpcAsyncStreamServer and one for the client grpcAsyncStreamClient. By the way, do you know you can get tab completion of .NET Core CLI commands? Very handy.\nServer I am using the default gRPC .NET Core template to generate the server part. The template creates a greet.proto file which I will duplicate between the server and the client project. As I want to experience with the streaming capability of gRPC, I am modifying the greet.proto file adding the keyword stream in front of the SayHello HelloReply response.\nServer streaming RPCA server-streaming RPC is similar to our simple example, except the server sends back a stream of responses after getting the client’s request message. After sending back all its responses, the server’s status details (status code and optional status message) and optional trailing metadata are sent back to complete on the server side. The client completes once it has all the server’s responses.\n\n\n Here is how the greet.proto looks like.\ngreet.proto1syntax &#x3D; &quot;proto3&quot;;23option csharp_namespace &#x3D; &quot;grpcAsyncStreamServer&quot;;45package Greet;67&#x2F;&#x2F; The greeting service definition.8service Greeter &#123;9  &#x2F;&#x2F; Sends a greeting10  rpc SayHello (HelloRequest) returns (stream HelloReply);11&#125;1213&#x2F;&#x2F; The request message containing the user&#39;s name.14message HelloRequest &#123;15  string name &#x3D; 1;16&#125;1718&#x2F;&#x2F; The response message containing the greetings.19message HelloReply &#123;20  string message &#x3D; 1;21&#125;\n\nI modify the code of the GreeterService class coming from the template to stream 10 HelloReply back to the client, with a small delay of 200ms in between each string returned to simulate some work.\nGreeterService.cs1public class GreeterService : Greeter.GreeterBase2&#123;3    private readonly ILogger&lt;GreeterService&gt; _logger;4    public GreeterService(ILogger&lt;GreeterService&gt; logger)5    &#123;6        _logger = logger;7    &#125;89    public override async Task SayHello(HelloRequest request, IServerStreamWriter&lt;HelloReply&gt; responseStream,                                            ServerCallContext context)10    &#123;11        foreach (var x in Enumerable.Range(1, 10))12        &#123;13            await responseStream.WriteAsync(new HelloReply14            &#123;15                Message = $\"Hello &#123;request.Name&#125; &#123;x&#125;\"16            &#125;);1718            await Task.Delay(200);19        &#125;20    &#125;21&#125;\n\nClientFor the client, I am creating a new Console application and copying the greet.proto into a new folder which I name Protos. Then I need to add the dependencies that you can see on the following csproj, so that at compilation time, the proto file is projected to C# code which I can use in my code. That’s nice because it means that you also get after a first compilation IntelliSense auto-completion.\ngrpcAsyncStreamClient.csproj1&lt;Project Sdk=\"Microsoft.NET.Sdk\"&gt;23  &lt;PropertyGroup&gt;4    &lt;OutputType&gt;Exe&lt;/OutputType&gt;5    &lt;TargetFramework&gt;netcoreapp3.0&lt;/TargetFramework&gt;6  &lt;/PropertyGroup&gt;78  &lt;ItemGroup&gt;9    &lt;PackageReference Include=\"Google.Protobuf\" Version=\"3.9.1\" /&gt;10    &lt;PackageReference Include=\"Grpc.Core\" Version=\"2.23.0\" /&gt;11    &lt;PackageReference Include=\"Grpc.Net.Client\" Version=\"0.2.23\" /&gt;12    &lt;PackageReference Include=\"Grpc.Tools\" Version=\"2.23.0\" /&gt;13  &lt;/ItemGroup&gt;1415  &lt;ItemGroup&gt;16    &lt;Protobuf Include=\"Protos\\greet.proto\"&gt;17      &lt;GrpcServices&gt;Client&lt;/GrpcServices&gt;18      &lt;Access&gt;Public&lt;/Access&gt;19      &lt;ProtoCompile&gt;True&lt;/ProtoCompile&gt;20      &lt;CompileOutputs&gt;True&lt;/CompileOutputs&gt;21      &lt;OutputDir&gt;obj\\Debug\\netcoreapp3.0\\&lt;/OutputDir&gt;22      &lt;Generator&gt;MSBuild:Compile&lt;/Generator&gt;23    &lt;/Protobuf&gt;24  &lt;/ItemGroup&gt;25  26&lt;/Project&gt;\n\nWe can now use the new C# 8 Async stream to iterate on the server answers asynchronously.\nC# has support for iterator methods and async methods, but no support for a method that is both an iterator and an async method. We should rectify this by allowing for await to be used in a new form of async iterator, one that returns an IAsyncEnumerable or IAsyncEnumerator rather than an IEnumerable or IEnumerator, with IAsyncEnumerable consumable in a new await foreach. An IAsyncDisposable interface is also used to enable asynchronous cleanup.\n\n\nThe code is greatly readable with this.\nProgram.cs1static class Program2&#123;3    static async Task Main(string[] args)4    &#123;5        var channel = GrpcChannel.ForAddress(\"https://localhost:5001\");6        var client = new Greeter.GreeterClient(channel);78        var replies = client.SayHello(new HelloRequest &#123; Name = \"Laurent\" &#125;);910        await foreach (var reply in replies.ResponseStream.ReadAllAsync())11        &#123;12            Console.WriteLine(reply.Message);13        &#125;14    &#125;15&#125;\n\nConclusionWe have seen that C# 8 Async streams are nicely integrating with gRPC streaming capabilities. And it makes code more readable!\nYou can get all the code on GitHub\n\n  \n\n\n\n","dateCreated":"2019-09-18T17:23:00+00:00","dateModified":"2020-02-08T08:04:02+00:00","datePublished":"2019-09-18T17:23:00+00:00","description":"gRPC and its idea to describe an API in a standardized file, which can generate both client and server code to interact in different languages is a compelling idea.In this post, I would like to have a quick look at the experience you would have with gRPC streaming capability and the new C# 8 async streams, which sounds like a perfect match.","headline":"gRPC and C# 8 Async stream","image":["https://live.staticflickr.com/65535/48736714892_5d8efce2bd_q.jpg","https://live.staticflickr.com/65535/48736714892_a7c405d990_h.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"/https:/laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/"},"publisher":{"@type":"Organization","name":"Laurent Kempé","sameAs":["https://github.com/laurentkempe","https://twitter.com/laurentkempe","https://www.linkedin.com/in/laurentkempe","https://flickr.com/photos/laurentkempe/"],"image":"https://farm2.staticflickr.com/1971/31306281378_02b055ccfe_q.jpg","logo":{"@type":"ImageObject","url":"https://farm2.staticflickr.com/1971/31306281378_02b055ccfe_q.jpg"}},"url":"/https:/laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/","keywords":"ASP.NET Core, C#, gRPC","thumbnailUrl":"https://live.staticflickr.com/65535/48736714892_5d8efce2bd_q.jpg"}</script>
    <meta name="description" content="gRPC and its idea to describe an API in a standardized file, which can generate both client and server code to interact in different languages is a compelling idea.In this post, I would like to have a">
<meta name="keywords" content="ASP.NET Core,C#,gRPC">
<meta property="og:type" content="blog">
<meta property="og:title" content="gRPC and C# 8 Async stream">
<meta property="og:url" content="https:&#x2F;&#x2F;laurentkempe.com&#x2F;2019&#x2F;09&#x2F;18&#x2F;gRPC-and-csharp-8-Async-stream&#x2F;index.html">
<meta property="og:site_name" content="Laurent Kempé">
<meta property="og:description" content="gRPC and its idea to describe an API in a standardized file, which can generate both client and server code to interact in different languages is a compelling idea.In this post, I would like to have a">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-02-08T08:04:02.597Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@laurentkempe">
    
    
        
    
    
        <meta property="og:image" content="https://farm2.staticflickr.com/1971/31306281378_02b055ccfe_q.jpg"/>
    
    
        <meta property="og:image" content="https://live.staticflickr.com/65535/48736714892_5d8efce2bd_q.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://live.staticflickr.com/65535/48736714892_5d8efce2bd_q.jpg"/>
    
    
        <meta property="og:image" content="https://live.staticflickr.com/65535/48736714892_a7c405d990_h.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://live.staticflickr.com/65535/48736714892_a7c405d990_h.jpg"/>
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-idpcjxkaoprv85vpsr9iigse5t6eyf1achm8s8y4xg9zgitqhlvmktwo5fpk.min.css">
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-64298-8"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-64298-8');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Laurent Kempé
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="global.open_link: /#about"
            >
        
        
            <img class="header-picture" src="https://farm2.staticflickr.com/1971/31306281378_02b055ccfe_q.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="global.read_more_about_author"
                >
                    <img class="sidebar-profile-picture" src="https://farm2.staticflickr.com/1971/31306281378_02b055ccfe_q.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Laurent Kempé</h4>
                
                    <h5 class="sidebar-profile-bio"><p>I am an experienced Team Leader &amp; Senior Solutions Architect with a passion for shipping high-quality products by empowering development team and culture toward an agile mindset. I bring technical vision and strategy, leading engineering teams to move product, processes and architecture forward.</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/"
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/about-laurent-kempe.html"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/laurentkempe" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://twitter.com/laurentkempe" target="_blank" rel="noopener" title="Twitter">
                    
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.linkedin.com/in/laurentkempe" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://flickr.com/photos/laurentkempe/" target="_blank" rel="noopener" title="Flickr">
                    
                        <i class="sidebar-button-icon fab fa-flickr" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Flickr</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="http://feeds.feedburner.com/laurentkempe" target="_blank" rel="noopener" title="RSS">
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-left
                    post-header-cover--partial"
             style="background-image:url('https://live.staticflickr.com/65535/48736714892_a7c405d990_h.jpg');"
             data-behavior="5">
            
                <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            gRPC and C# 8 Async stream
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2019-09-18T17:23:00+00:00">
	
		    Sep 18, 2019
    	
    </time>
    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="5"
                 class="hasCover
                        hasCoverMetaIn
                        hasCoverCaption">
                
<article class="post">
    
        <span class="post-header-cover-caption caption">Purcaraccia, Corse, France</span>
    
    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p><a href="https://grpc.io/" target="_blank" rel="noopener">gRPC</a> and its idea to describe an API in a standardized file, which can generate both client and server code to interact in different languages is a compelling idea.<br>In this post, I would like to have a quick look at the experience you would have with gRPC streaming capability and the new <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/proposals/csharp-8.0/async-streams" target="_blank" rel="noopener">C# 8 async streams</a>, which sounds like a perfect match.</p>
<a id="more"></a>
<p>I am using the <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/?tabs=netcore2x" target="_blank" rel="noopener">.NET Core CLI</a> to create the solution with two projects, one for the server called grpcAsyncStreamServer and one for the client grpcAsyncStreamClient. By the way, do you know you can get <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/enable-tab-autocomplete" target="_blank" rel="noopener">tab completion of .NET Core CLI</a> commands? Very handy.</p>
<h1 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h1><p> I am using the default gRPC .NET Core template to generate the server part. The template creates a greet.proto file which I will duplicate between the server and the client project. As I want to experience with the <a href="https://www.grpc.io/docs/guides/concepts/" target="_blank" rel="noopener">streaming capability of gRPC</a>, I am modifying the greet.proto file adding the keyword stream in front of the SayHello HelloReply response.</p>
<div class="alert info"><p>Server streaming RPC<br>A server-streaming RPC is similar to our simple example, except <strong>the server sends back a stream of responses after getting the client’s request message</strong>. After sending back all its responses, the server’s status details (status code and optional status message) and optional trailing metadata are sent back to complete on the server side. <strong>The client completes once it has all the server’s responses</strong>.</p>
</div>

<p> Here is how the greet.proto looks like.</p>
<figure class="highlight plain"><figcaption><span>greet.proto</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">syntax &#x3D; &quot;proto3&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">option csharp_namespace &#x3D; &quot;grpcAsyncStreamServer&quot;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">package Greet;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; The greeting service definition.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">service Greeter &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  &#x2F;&#x2F; Sends a greeting</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  rpc SayHello (HelloRequest) returns (stream HelloReply);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; The request message containing the user&#39;s name.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">message HelloRequest &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  string name &#x3D; 1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; The response message containing the greetings.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">message HelloReply &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">  string message &#x3D; 1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>I modify the code of the GreeterService class coming from the template to stream 10 HelloReply back to the client, with a small delay of 200ms in between each string returned to simulate some work.</p>
<figure class="highlight csharp"><figcaption><span>GreeterService.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public class GreeterService : Greeter.GreeterBase</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;GreeterService&gt; _logger;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GreeterService</span>(<span class="params">ILogger&lt;GreeterService&gt; logger</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        _logger = logger;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task <span class="title">SayHello</span>(<span class="params">HelloRequest request, IServerStreamWriter&lt;HelloReply&gt; responseStream,                                            ServerCallContext context</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> x <span class="keyword">in</span> Enumerable.Range(<span class="number">1</span>, <span class="number">10</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">await</span> responseStream.WriteAsync(<span class="keyword">new</span> HelloReply</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">                Message = <span class="string">$"Hello <span class="subst">&#123;request.Name&#125;</span> <span class="subst">&#123;x&#125;</span>"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">await</span> Task.Delay(<span class="number">200</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h1 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h1><p>For the client, I am creating a new Console application and copying the greet.proto into a new folder which I name Protos. Then I need to add the dependencies that you can see on the following csproj, so that at compilation time, the proto file is projected to C# code which I can use in my code. That’s nice because it means that you also get after a first compilation IntelliSense auto-completion.</p>
<figure class="highlight xml"><figcaption><span>grpcAsyncStreamClient.csproj</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">"Microsoft.NET.Sdk"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">OutputType</span>&gt;</span>Exe<span class="tag">&lt;/<span class="name">OutputType</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>netcoreapp3.0<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Google.Protobuf"</span> <span class="attr">Version</span>=<span class="string">"3.9.1"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Grpc.Core"</span> <span class="attr">Version</span>=<span class="string">"2.23.0"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Grpc.Net.Client"</span> <span class="attr">Version</span>=<span class="string">"0.2.23"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">PackageReference</span> <span class="attr">Include</span>=<span class="string">"Grpc.Tools"</span> <span class="attr">Version</span>=<span class="string">"2.23.0"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;<span class="name">ItemGroup</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">Protobuf</span> <span class="attr">Include</span>=<span class="string">"Protos\greet.proto"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">GrpcServices</span>&gt;</span>Client<span class="tag">&lt;/<span class="name">GrpcServices</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">Access</span>&gt;</span>Public<span class="tag">&lt;/<span class="name">Access</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">ProtoCompile</span>&gt;</span>True<span class="tag">&lt;/<span class="name">ProtoCompile</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">CompileOutputs</span>&gt;</span>True<span class="tag">&lt;/<span class="name">CompileOutputs</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">OutputDir</span>&gt;</span>obj\Debug\netcoreapp3.0\<span class="tag">&lt;/<span class="name">OutputDir</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">Generator</span>&gt;</span>MSBuild:Compile<span class="tag">&lt;/<span class="name">Generator</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">Protobuf</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">  <span class="tag">&lt;/<span class="name">ItemGroup</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">Project</span>&gt;</span></span></pre></td></tr></table></figure>

<p>We can now use the new C# 8 Async stream to iterate on the server answers asynchronously.</p>
<div class="alert info"><p>C# has support for iterator methods and async methods, but no support for a method that is both an iterator and an async method. We should rectify this by allowing for await to be used in a new form of async iterator, one that returns an IAsyncEnumerable<T> or IAsyncEnumerator<T> rather than an IEnumerable<T> or IEnumerator<T>, with IAsyncEnumerable<T> consumable in a new await foreach. An IAsyncDisposable interface is also used to enable asynchronous cleanup.</p>
</div>

<p>The code is greatly readable with this.</p>
<figure class="highlight csharp"><figcaption><span>Program.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Program</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">var</span> channel = GrpcChannel.ForAddress(<span class="string">"https://localhost:5001"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">var</span> client = <span class="keyword">new</span> Greeter.GreeterClient(channel);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">var</span> replies = client.SayHello(<span class="keyword">new</span> HelloRequest &#123; Name = <span class="string">"Laurent"</span> &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">await</span> <span class="keyword">foreach</span> (<span class="keyword">var</span> reply <span class="keyword">in</span> replies.ResponseStream.ReadAllAsync())</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            Console.WriteLine(reply.Message);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>We have seen that C# 8 Async streams are nicely integrating with gRPC streaming capabilities. And it makes code more readable!</p>
<p>You can get all the code on GitHub</p>
<div style="text-align: left">
  <div class="github-card"
    data-user="laurentkempe"
    data-repo="grpcAsyncStream"
    data-height="200"
    data-width="400"
    data-theme="default"
    data-target=""
    data-client-id=""
    data-client-secret=""
  ></div>
</div>
<script src="/github-card-lib/githubcard.js"></script>


            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/ASP-NET-Core/" rel="tag">ASP.NET Core</a> <a class="tag tag--primary tag--small t-link" href="/tags/C/" rel="tag">C#</a> <a class="tag tag--primary tag--small t-link" href="/tags/gRPC/" rel="tag">gRPC</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/09/25/gRPC-and-csharp-8-Async-stream-cancellation/"
                    data-tooltip="gRPC and C# 8 Async stream cancellation"
                    aria-label="PREVIOUS: gRPC and C# 8 Async stream cancellation"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/09/03/WPF-and-dotnet-Generic-Host-with-dotnet-Core-3-0/"
                    data-tooltip="WPF and .NET Generic Host with .NET Core 3.0"
                    aria-label="NEXT: WPF and .NET Generic Host with .NET Core 3.0"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Laurent Kempé. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/09/25/gRPC-and-csharp-8-Async-stream-cancellation/"
                    data-tooltip="gRPC and C# 8 Async stream cancellation"
                    aria-label="PREVIOUS: gRPC and C# 8 Async stream cancellation"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/09/03/WPF-and-dotnet-Generic-Host-with-dotnet-Core-3-0/"
                    data-tooltip="WPF and .NET Generic Host with .NET Core 3.0"
                    aria-label="NEXT: WPF and .NET Generic Host with .NET Core 3.0"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/"
                        aria-label="Share on Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="https://farm2.staticflickr.com/1971/31306281378_02b055ccfe_q.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Laurent Kempé</h4>
        
            <div id="about-card-bio"><p>I am an experienced Team Leader &amp; Senior Solutions Architect with a passion for shipping high-quality products by empowering development team and culture toward an agile mindset. I bring technical vision and strategy, leading engineering teams to move product, processes and architecture forward.</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Team Leader, Senior Solutions Architect</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Illzach, France
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('https://farm5.staticflickr.com/4437/37116073235_dda239221d_o.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-wckp0qgtbcok7hs56xlrmi6rtiftev91saxk2w1ob3ptobf11jse6apkxl93.min.js"></script>
<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://laurentkempe.com/2019/09/18/gRPC-and-csharp-8-Async-stream/';
              
            this.page.identifier = '20190918192300';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'laurentkempe';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
    




    </body>
</html>
